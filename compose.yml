services:
  postgres:
    image: postgres:16
    environment:
      POSTGRES_USER: ducklake
      POSTGRES_PASSWORD: ducklake
      POSTGRES_DB: ducklake
    logging:
      driver: none
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ducklake"]
      interval: 2s
      timeout: 5s
      retries: 10

  s3:
    image: rustfs/rustfs:latest
    environment:
      RUSTFS_ACCESS_KEY: rustfsadmin
      RUSTFS_SECRET_KEY: rustfsadmin
    command: ["--access-key", "rustfsadmin", "--secret-key", "rustfsadmin", "/data"]
    logging:
      driver: none
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/health"]
      interval: 2s
      timeout: 5s
      retries: 10

  s3-init:
    image: minio/mc:latest
    depends_on:
      s3:
        condition: service_healthy
    logging:
      driver: none
    entrypoint: >
      /bin/sh -c "
      mc alias set s3 http://s3:9000 rustfsadmin rustfsadmin &&
      mc mb --ignore-existing s3/ducklake
      "

  repro:
    build: .
    depends_on:
      postgres:
        condition: service_healthy
      s3-init:
        condition: service_completed_successfully
